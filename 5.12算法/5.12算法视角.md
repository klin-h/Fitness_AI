# 5.12 算法视角

  

算法视角详细说明 FitnessAI 系统中深度学习算法的处理步骤、计算公式、训练流程及预测推理的实现细节。本视角聚焦于深蹲状态分类器的核心算法实现，为开发人员提供精确的算法规约，确保模型训练与推理的一致性。

  

## 5.12.1 算法概述

  

FitnessAI 的深度学习模块采用**监督学习**方法，基于 MediaPipe 提取的 33 个姿态关键点坐标，通过特征工程与深度神经网络，实现对深蹲动作状态的自动分类。系统支持三种状态分类：

  

- **状态 0（站直）**：用户处于站立姿态，膝盖角度接近 $180^\circ$。

- **状态 1（半蹲）**：用户处于半蹲姿态，膝盖角度在 $90^\circ$ 至 $150^\circ$ 之间。

- **状态 2（完全蹲下）**：用户处于完全蹲下姿态，膝盖角度小于 $90^\circ$。

  

算法流程分为四个核心阶段：**特征提取**、**模型构建**、**模型训练**、**状态预测**。

  

## 5.12.2 特征提取算法

  

### 5.12.2.1 输入数据格式

  

特征提取算法的输入为 MediaPipe Pose 模型输出的 33 个关键点坐标。每个关键点 $P_i$ 包含：

  

$$P_i = \{x, y, z, v\}$$

  

其中 $x, y, z \in [0, 1]$ 为归一化坐标，$v \in [0, 1]$ 为可见性置信度。

  

### 5.12.2.2 关键点索引映射

  

算法仅使用与深蹲动作相关的 8 个关键点（定义于 `MediaPipeIndices` 枚举）：

  

|**关键点名称**|**索引**|**用途**|

|---|---|---|

|左/右肩 (SHOULDER)|11, 12|计算髋部角度、肩膀垂直高度|

|左/右髋 (HIP)|23, 24|计算膝盖角度、髋部垂直高度|

|左/右膝 (KNEE)|25, 26|计算膝盖角度、水平偏移量|

|左/右踝 (ANKLE)|27, 28|计算膝盖角度、高度基准点|

  

### 5.12.2.3 角度计算算法

  

角度计算是特征工程的核心。计算以点 $B$ 为顶点的夹角 $\angle ABC$。

  

计算公式：

  

构建向量 $\vec{BA}$ 和 $\vec{BC}$：

  

$$\vec{v_1} = A - B, \quad \vec{v_2} = C - B$$

  

计算夹角 $\theta$（单位：度）：

  

$$\theta = \arccos\left( \frac{\vec{v_1} \cdot \vec{v_2}}{\|\vec{v_1}\| \|\vec{v_2}\|} \right) \times \frac{180}{\pi}$$

  

数值保护：

  

若 $\|\vec{v_1}\| \approx 0$ 或 $\|\vec{v_2}\| \approx 0$，则返回默认值 $180.0^\circ$。

  

### 5.12.2.4 特征向量构建

  

函数 `extract_squat_features()` 输出一个 **24 维** 特征向量 $\mathbf{X}$，包含几何特征与原始坐标。

  

**1. 基础几何特征（8 维）**：

  

|**索引**|**特征名称**|**单位**|**物理意义**|

|---|---|---|---|

|0, 1|左/右膝盖角度|度 ($^\circ$)|衡量腿部弯曲程度 (核心指标)|

|2, 3|左/右髋部角度|度 ($^\circ$)|衡量躯干前倾程度|

|4|髋关节相对高度|标量|$(y_{hip} - y_{ankle})$，衡量下蹲深度|

|5|肩膀相对高度|标量|$(y_{shoulder} - y_{ankle})$，衡量整体高度|

|6, 7|左/右膝水平偏移|标量|$(x_{knee} - x_{ankle})$，检测膝盖是否过脚尖|

  

2. 原始坐标特征（16 维）：

  

包含 8 个关键点的 $(x, y)$ 原始归一化坐标，用于保留空间位置信息，辅助模型学习非线性关系。

  

## 5.12.3 深度学习模型架构

  

### 5.12.3.1 网络结构设计

  

深蹲分类器采用**全连接前馈神经网络 (MLP)**。下图展示了各层的连接关系及维度变换。

  

![深度学习模型架构图](pictures/深度学习模型架构图.png)

### 5.12.3.2 核心层数学原理

  

1. 全连接层 (Dense)

  

执行线性变换与非线性激活：

  

$$\mathbf{h} = \text{ReLU}(\mathbf{W}\mathbf{x} + \mathbf{b})$$

  

2. 批归一化 (Batch Normalization)

  

标准化输入分布，加速收敛：

  

$$\hat{x} = \frac{x - \mu_B}{\sqrt{\sigma_B^2 + \epsilon}} \cdot \gamma + \beta$$

  

3. 输出层 (Softmax)

  

将 logits 转换为概率分布 $P(y)$：

  

$$P(y_i) = \frac{e^{z_i}}{\sum_{j=1}^{C} e^{z_j}}$$

  

其中 $C=3$ 为类别总数。

  

### 5.12.3.3 模型参数统计

  

|**层级**|**类型**|**输出形状**|**参数量**|

|---|---|---|---|

|Input|InputLayer|(None, 24)|0|

|Hidden 1|Dense + BN|(None, 128)|3,456|

|Hidden 2|Dense + BN|(None, 64)|8,384|

|Hidden 3|Dense + BN|(None, 32)|2,144|

|Output|Dense (Softmax)|(None, 3)|99|

|**Total**|-|-|**~14,083**|

  

## 5.12.4 模型训练算法

  

### 5.12.4.1 损失函数与优化器

  

- 损失函数：稀疏分类交叉熵 (Sparse Categorical Crossentropy)

    $$L = -\frac{1}{N} \sum_{i=1}^{N} \log(P(y_i^{true}))$$

- **优化器**：Adam

    - 初始学习率 $\alpha = 0.001$

    - 一阶矩衰减 $\beta_1 = 0.9$

    - 二阶矩衰减 $\beta_2 = 0.999$

  

### 5.12.4.2 数据增强策略

  

为了提高模型的泛化能力，防止过拟合，训练过程采用了以下增强手段：

  

1. 高斯噪声注入

  

在关键点坐标上叠加随机噪声，模拟摄像头抖动：

  

$$\mathbf{x}_{aug} = \mathbf{x}_{orig} + \mathcal{N}(0, \sigma^2)$$

  

其中 $\sigma = 0.01$。

  

2. 水平翻转

  

通过对"左/右"关键点进行索引互换及 X 坐标镜像，将样本量扩充 2 倍。

  

3. SMOTE 过采样

  

在特征空间对少数类（如"半蹲"）生成合成样本，平衡数据集分布。

  

### 5.12.4.3 训练策略优化

  

1. 类别权重平衡：

    针对“半蹲”样本较少的情况，自动计算权重：

    $$w_j = \frac{N_{total}}{C \times N_j}$$

2. 早停机制 (Early Stopping)：

    监控验证集损失 $L_{val}$，若连续 patience=15 个 Epoch 不下降，则终止训练。

  

## 5.12.5 预测推理算法

  

### 5.12.5.1 推理数据流

  

预测过程是一个从原始关键点到语义状态的转化流水线。

  

![预测推理数据流图](pictures/预测推理数据流图.png)

  

### 5.12.5.2 详细处理步骤

  

1. **输入接收**：接收 MediaPipe 每一帧的 `pose_landmarks`。

2. **特征提取**：调用 `extract_squat_features()` 获取 24 维向量。

3. **预处理**：执行 `reshape(1, 24)` 以匹配 batch 维度。

4. **前向传播**：模型输出 3 维概率向量 $[p_0, p_1, p_2]$。

5. **后处理与决策**：

    - 预测类别：$c = \operatorname{argmax}(p)$

    - 置信度：$conf = \max(p)$

  

## 5.12.6 结果平滑与去抖动

  

由于视频流输入存在波动，系统引入 **EMA 滤波器** 和 **状态迟滞切换** 机制。

  

### 5.12.6.1 指数移动平均滤波 (EMA)

  

对概率向量进行时间序列平滑：

  

$$\hat{P}_t = \alpha \cdot P_t + (1 - \alpha) \cdot \hat{P}_{t-1}$$

  

其中 $\alpha=0.7$。此操作能显著减少 UI 闪烁。

  

### 5.12.6.2 状态迟滞切换

  

为防止状态边界反复跳变，系统规定：仅当新状态的置信度**持续 3 帧**超过阈值 $0.7$ 时，才触发状态切换。

  

## 5.12.7 模型持久化与部署

  

1. 模型序列化

  

训练完成的模型被导出为 HDF5 (.h5) 格式，文件包含：

  

- 模型架构配置 (JSON)

- 权重参数矩阵 (Weights)

- 优化器状态（用于断点续训）

  

2. 运行时加载

  

后端服务启动时，SquatClassifier 单例类通过 TensorFlow/Keras API 加载模型文件至内存，并执行一次预热推理，输入全零向量，以消除首次请求的延迟。

  

## 5.12.8 算法验证与测试

  

模型性能通过混淆矩阵与 F1-Score 进行量化评估。

  

评估指标公式：

  

$$\text{Precision}_k = \frac{TP_k}{TP_k + FP_k}, \quad \text{Recall}_k = \frac{TP_k}{TP_k + FN_k}$$

  

$$F1_k = 2 \times \frac{\text{Precision}_k \times \text{Recall}_k}{\text{Precision}_k + \text{Recall}_k}$$

  

**基准性能要求**：

  

- 总体准确率 (Accuracy) $> 85\%$

- 单次推理耗时 (Latency) $< 15ms$