# 后端启动问题排查指南

## ERR_CONNECTION_REFUSED 错误说明

`ERR_CONNECTION_REFUSED` 表示前端无法连接到后端服务器（localhost:8000）。

## 可能的原因

1. **后端服务器未启动**
   - 后端进程可能启动失败
   - 检查后端日志是否有错误

2. **数据库错误导致启动失败**
   - SQLAlchemy关系映射错误
   - 数据库表结构不匹配

3. **端口被占用**
   - 8000端口可能被其他程序占用

## 解决步骤

### 步骤1：检查后端是否运行

打开新的终端窗口，运行：
```bash
cd backend
python app.py
```

查看是否有错误信息。

### 步骤2：如果看到数据库错误

如果看到类似这样的错误：
```
Could not locate any relevant foreign key columns...
```

需要更新数据库表结构：

**方法1：删除数据库文件（如果数据不重要）**
- 删除项目根目录下的 `fitnessai.db` 文件
- 重启后端，会自动创建新表

**方法2：使用Python脚本更新**
```python
# backend/update_db.py
from database import db
from app import app

with app.app_context():
    db.drop_all()
    db.create_all()
    print("✅ 数据库表已更新")
```

运行：
```bash
cd backend
python update_db.py
```

### 步骤3：检查端口占用

Windows PowerShell:
```powershell
netstat -ano | findstr :8000
```

如果看到输出，说明端口被占用，需要：
1. 找到占用端口的进程ID（PID）
2. 结束该进程：`taskkill /pid <PID> /f`

### 步骤4：手动启动后端

如果 `start.py` 启动失败，可以手动启动：

```bash
cd backend
python app.py
```

应该看到类似输出：
```
✅ 数据库连接成功
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:8000
```

### 步骤5：测试后端连接

在浏览器中访问：
```
http://localhost:8000/api/health
```

应该返回JSON响应：
```json
{
  "status": "healthy",
  "database": "connected",
  "timestamp": "..."
}
```

## 常见错误和解决方案

### 错误1：数据库关系映射错误
**错误信息**：
```
Could not locate any relevant foreign key columns...
```

**解决方案**：
1. 确保 `backend/database.py` 中的 `sessions` relationship 使用了 `foreign()` 函数
2. 删除数据库文件并重新创建

### 错误2：模块导入错误
**错误信息**：
```
ModuleNotFoundError: No module named 'xxx'
```

**解决方案**：
```bash
cd backend
pip install -r requirements.txt
```

### 错误3：端口被占用
**错误信息**：
```
Address already in use
```

**解决方案**：
1. 找到占用端口的进程并结束它
2. 或者修改 `app.py` 中的端口号

## 快速修复脚本

创建一个 `fix_backend.py` 文件：

```python
import os
import sys

# 删除数据库文件
db_file = 'fitnessai.db'
if os.path.exists(db_file):
    os.remove(db_file)
    print(f"✅ 已删除 {db_file}")

# 检查后端目录
backend_dir = 'backend'
if not os.path.exists(backend_dir):
    print(f"❌ 后端目录不存在: {backend_dir}")
    sys.exit(1)

# 切换到后端目录
os.chdir(backend_dir)

# 更新数据库
from database import db
from app import app

with app.app_context():
    db.drop_all()
    db.create_all()
    print("✅ 数据库表已重新创建")

print("\n✅ 修复完成！现在可以启动后端了：")
print("   cd backend")
print("   python app.py")
```

运行：
```bash
python fix_backend.py
```

## 验证后端是否正常

启动后端后，应该能看到：
1. ✅ 数据库连接成功的消息
2. Flask开发服务器启动消息
3. 运行在 http://127.0.0.1:8000

如果看到错误，请查看错误信息并按照上述步骤解决。

