# 500错误修复说明

## 问题分析

### 1. `/api/user/plan` 500错误
**原因**：
- `get_user_plan` 函数没有错误处理
- 数据库查询可能失败但没有捕获异常

**修复**：
- 添加了 `@handle_db_error` 装饰器
- 添加了try-catch错误处理
- 如果查询失败，返回默认计划而不是错误

### 2. `/api/session/start` 500错误
**原因**：
- Session表有外键约束 `db.ForeignKey('users.user_id')`
- 当user_id为'anonymous'或不存在时，外键约束失败

**修复**：
- 移除了Session表的user_id外键约束
- 允许匿名用户创建会话
- 改进了错误处理和日志记录

## 修复内容

### 1. 数据库模型修改 (`backend/database.py`)
```python
# 修改前
user_id = db.Column(db.String(100), db.ForeignKey('users.user_id'), nullable=False, index=True)

# 修改后
user_id = db.Column(db.String(100), nullable=False, index=True)  # 移除外键约束，允许匿名用户
```

### 2. API端点改进 (`backend/app.py`)

#### `/api/user/plan` GET
- 添加了 `@handle_db_error` 装饰器
- 添加了完整的错误处理
- 查询失败时返回默认计划

#### `/api/session/start` POST
- 改进了错误处理
- 允许匿名用户创建会话
- 添加了详细的错误日志

### 3. 数据库适配层改进 (`backend/db_adapter.py`)

#### `get_user_plan`
- 添加了try-catch错误处理
- 查询失败时返回None而不是抛出异常

#### `create_session`
- 移除了对用户必须存在的强制检查
- 允许匿名用户创建会话
- 改进了错误处理

## 需要执行的操作

### 1. 更新数据库表结构
由于移除了外键约束，需要更新数据库表：

**方法1：删除并重建表（会丢失数据）**
```python
# 在Python环境中执行
from database import db, Session
from app import app

with app.app_context():
    db.drop_all()
    db.create_all()
    print("数据库表已重新创建")
```

**方法2：使用数据库迁移工具（推荐）**
```bash
# 如果使用Flask-Migrate
flask db migrate -m "Remove foreign key constraint from Session.user_id"
flask db upgrade
```

**方法3：手动修改SQLite数据库**
```sql
-- 备份数据
-- 删除旧表
DROP TABLE IF EXISTS sessions;

-- 重新创建表（无外键约束）
CREATE TABLE sessions (
    session_id VARCHAR(255) PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    exercise_type VARCHAR(50) NOT NULL,
    start_time DATETIME NOT NULL,
    end_time DATETIME,
    total_count INTEGER DEFAULT 0,
    correct_count INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active',
    scores TEXT
);

-- 创建索引
CREATE INDEX idx_user_status_time ON sessions(user_id, status, start_time);
CREATE INDEX idx_user_exercise_time ON sessions(user_id, exercise_type, start_time);
```

### 2. 重启后端服务
修复后需要重启Flask后端服务以使更改生效。

## 测试建议

1. **测试获取计划**
   - 登录后访问 `/api/user/plan`
   - 应该返回计划数据或默认计划，不应该返回500错误

2. **测试创建会话**
   - 登录后点击"开始检测"
   - 应该成功创建会话，不应该返回500错误

3. **检查日志**
   - 查看后端日志，确认没有错误
   - 如果有错误，查看详细的错误信息

## 注意事项

1. **数据迁移**：如果数据库中已有会话数据，更新表结构前请备份
2. **外键约束**：移除外键约束后，需要应用层保证数据一致性
3. **匿名用户**：现在允许匿名用户创建会话，但建议在查询时过滤掉匿名会话

