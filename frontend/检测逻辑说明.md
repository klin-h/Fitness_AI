# 姿态检测逻辑说明

## 检测流程

### 1. 初始化阶段
- **MediaPipe Pose 初始化** (`usePoseDetection.ts` 第131-179行)
  - 从CDN加载MediaPipe Pose模型文件
  - 配置检测参数：
    - `modelComplexity: 1` - 模型复杂度（0-2，1为平衡）
    - `smoothLandmarks: true` - 平滑关键点
    - `minDetectionConfidence: 0.5` - 最小检测置信度
    - `minTrackingConfidence: 0.5` - 最小跟踪置信度

### 2. 摄像头启动
- **Camera初始化** (`usePoseDetection.ts` 第161-169行)
  - 获取用户摄像头权限
  - 设置视频流分辨率：640x480
  - 每帧调用MediaPipe进行姿态检测

### 3. 实时检测循环
```
摄像头帧 → MediaPipe处理 → 返回关键点 → 绘制骨骼 → 分析动作
```

### 4. 骨骼点绘制 (`usePoseDetection.ts` 第49-84行)
- **关键点绘制**：
  - 使用 `drawLandmarks` 绘制33个关键点（红色，半径5px）
  - 关键点包括：脸部、肩膀、手臂、躯干、腿部等

- **骨骼连接线绘制**：
  - 使用 `drawConnectors` 和 `POSE_CONNECTIONS` 绘制连接线（绿色，线宽3px）
  - 连接关系包括：
    - 上身：肩膀-手肘-手腕
    - 躯干：肩膀-臀部
    - 腿部：臀部-膝盖-脚踝

### 5. 动作分析 (`exerciseAnalyzer.ts`)
根据不同的运动类型，使用不同的分析逻辑：

#### 深蹲 (SquatAnalyzer)
- **检测方法**：计算膝盖角度
- **关键点**：臀部(23,24) → 膝盖(25,26) → 脚踝(27,28)
- **判定逻辑**：
  - 膝盖角度 < 90°：下蹲状态
  - 膝盖角度 > 160°：站立状态
  - 从下蹲到站立：完成一次深蹲

#### 俯卧撑 (PushupAnalyzer)
- **检测方法**：计算手臂角度
- **关键点**：肩膀(11,12) → 手肘(13,14) → 手腕(15,16)
- **判定逻辑**：
  - 手臂角度 < 90°：下压状态
  - 手臂角度 > 160°：上推状态
  - 从下压到上推：完成一次俯卧撑

#### 平板支撑 (PlankAnalyzer)
- **检测方法**：检查身体是否保持直线
- **关键点**：肩膀、臀部、膝盖、脚踝
- **判定逻辑**：
  - 计算身体各部位Y坐标的偏差
  - 偏差 < 0.05：正确姿势，开始计时
  - 偏差 > 0.1：姿势不正确

#### 开合跳 (JumpingJackAnalyzer)
- **检测方法**：计算手臂和腿部距离
- **关键点**：手腕(15,16)、脚踝(27,28)
- **判定逻辑**：
  - 手臂和腿部同时打开：打开状态
  - 手臂和腿部同时闭合：闭合状态
  - 从打开到闭合：完成一次开合跳

## 为什么看不到骨骼点？

### 可能的原因：

1. **MediaPipe资源加载失败**
   - 检查浏览器控制台是否有CDN连接错误
   - 错误信息：`Failed to load resource: net::ERR_CONNECTION_TIMED_OUT`
   - **解决方案**：检查网络连接，或使用本地MediaPipe文件

2. **Canvas尺寸不匹配**
   - Canvas的CSS尺寸和实际像素尺寸不一致
   - **已修复**：在 `drawPose` 函数中正确设置canvas尺寸

3. **关键点未检测到**
   - 摄像头未正确启动
   - 人体不在画面中
   - 光线不足
   - **检查方法**：查看浏览器控制台是否有"检测到 X 个关键点"的日志

4. **Canvas被遮挡**
   - Canvas的z-index设置不正确
   - **已修复**：设置 `zIndex: 10`

5. **绘制函数未执行**
   - MediaPipe的 `onResults` 回调未触发
   - **检查方法**：在 `drawPose` 函数中添加 `console.log` 查看是否执行

## 调试方法

### 1. 检查MediaPipe是否加载成功
在浏览器控制台输入：
```javascript
// 检查MediaPipe是否可用
console.log(window.Pose);
```

### 2. 检查关键点检测
在 `drawPose` 函数中已添加日志：
```javascript
console.log(`检测到 ${results.poseLandmarks.length} 个关键点`);
```

### 3. 检查Canvas尺寸
在浏览器控制台输入：
```javascript
const canvas = document.querySelector('canvas');
console.log('Canvas尺寸:', canvas.width, canvas.height);
const video = document.querySelector('video');
console.log('Video尺寸:', video.videoWidth, video.videoHeight);
```

### 4. 手动绘制测试
在浏览器控制台输入：
```javascript
const canvas = document.querySelector('canvas');
const ctx = canvas.getContext('2d');
ctx.fillStyle = 'red';
ctx.fillRect(10, 10, 50, 50);
// 如果能看到红色方块，说明canvas可以正常绘制
```

## 改进建议

1. **添加调试模式**
   - 显示检测到的关键点数量
   - 显示检测置信度
   - 显示FPS（帧率）

2. **优化绘制性能**
   - 只在检测到关键点时绘制
   - 使用requestAnimationFrame优化动画

3. **添加错误处理**
   - MediaPipe加载失败时的降级方案
   - 摄像头权限被拒绝时的提示

4. **改进视觉效果**
   - 根据检测置信度调整关键点大小
   - 添加关键点标签（如"左肩"、"右膝"等）
   - 添加动作轨迹线

